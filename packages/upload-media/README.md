# `@mexp/upload-media`

Core media upload logic implemented with a custom `@wordpress/data` store.

## API Reference

### Actions

The following set of dispatching action creators are available on the object returned by `wp.data.dispatch( 'media-experiments/upload' )`:

**Note:** Some actions and selectors [will be made private](https://github.com/swissspidy/media-experiments/issues/500) eventually, limiting the public API.

<!-- START TOKEN(Autogenerated actions|src/store/actions.ts) -->

#### addItem

Adds a new item to the upload queue.

_Parameters_

-   _$0_ `AddItemArgs`: 
-   _$0.file_ `AddItemArgs[ 'file' ]`: File
-   _$0.batchId_ `[AddItemArgs[ 'batchId' ]]`: Batch ID.
-   _$0.onChange_ `[AddItemArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[AddItemArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onBatchSuccess_ `[AddItemArgs[ 'onBatchSuccess' ]]`: Function called after a batch of files is uploaded.
-   _$0.onError_ `[AddItemArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[AddItemArgs[ 'additionalData' ]]`: Additional data to include in the request.
-   _$0.sourceUrl_ `[AddItemArgs[ 'sourceUrl' ]]`: Source URL. Used when importing a file from a URL or optimizing an existing file.
-   _$0.sourceAttachmentId_ `[AddItemArgs[ 'sourceAttachmentId' ]]`: Source attachment ID. Used when optimizing an existing file for example.
-   _$0.mediaSourceTerms_ `[AddItemArgs[ 'mediaSourceTerms' ]]`: List of term slugs in the media source taxonomy. Used to identify files later on in the media library.
-   _$0.blurHash_ `[AddItemArgs[ 'blurHash' ]]`: Item's BlurHash.
-   _$0.dominantColor_ `[AddItemArgs[ 'dominantColor' ]]`: Item's dominant color.
-   _$0.abortController_ `[AddItemArgs[ 'abortController' ]]`: Abort controller for upload cancellation.
-   _$0.operations_ `[AddItemArgs[ 'operations' ]]`: List of operations to perform. Defaults to automatically determined list, based on the file.

#### addItemFromUrl

Adds a new item to the upload queue.

_Parameters_

-   _$0_ `AddItemFromUrlArgs`: 
-   _$0.url_ `AddItemFromUrlArgs[ 'url' ]`: URL
-   _$0.onChange_ `[AddItemFromUrlArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[AddItemFromUrlArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onError_ `[AddItemFromUrlArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[AddItemFromUrlArgs[ 'additionalData' ]]`: Additional data to include in the request.

#### addItems

Adds a new item to the upload queue.

_Parameters_

-   _$0_ `AddItemsArgs`: 
-   _$0.files_ `AddItemsArgs[ 'files' ]`: Files
-   _$0.onChange_ `[AddItemsArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[AddItemsArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onBatchSuccess_ `[AddItemsArgs[ 'onBatchSuccess' ]]`: Function called after a batch of files is uploaded.
-   _$0.onError_ `[AddItemsArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[AddItemsArgs[ 'additionalData' ]]`: Additional data to include in the request.

#### addPosterForItem

Triggers poster image generation for an item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### addSideloadItem

Adds a new item to the upload queue for sideloading.

This is typically a poster image or a client-side generated thumbnail.

_Parameters_

-   _$0_ `AddSideloadItemArgs`: 
-   _$0.file_ `AddSideloadItemArgs[ 'file' ]`: File
-   _$0.batchId_ `[AddSideloadItemArgs[ 'batchId' ]]`: Batch ID.
-   _$0.parentId_ `[AddSideloadItemArgs[ 'parentId' ]]`: Parent ID.
-   _$0.onChange_ `[AddSideloadItemArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.additionalData_ `[AddSideloadItemArgs[ 'additionalData' ]]`: Additional data to include in the request.
-   _$0.operations_ `[AddSideloadItemArgs[ 'operations' ]]`: List of operations to perform. Defaults to automatically determined list, based on the file.

#### addSubtitlesForExistingVideo

Adds a new item to the upload queue to generate subtitles for an existing video.

_Parameters_

-   _$0_ `AddSubtitlesForExistingVideoArgs`: 
-   _$0.id_ `AddSubtitlesForExistingVideoArgs[ 'id' ]`: Attachment ID.
-   _$0.url_ `AddSubtitlesForExistingVideoArgs[ 'url' ]`: URL.
-   _$0.fileName_ `[AddSubtitlesForExistingVideoArgs[ 'fileName' ]]`: File name.
-   _$0.onChange_ `[AddSubtitlesForExistingVideoArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[AddSubtitlesForExistingVideoArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onError_ `[AddSubtitlesForExistingVideoArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[AddSubtitlesForExistingVideoArgs[ 'additionalData' ]]`: Additional data to include in the request.

#### cancelItem

Cancels an item in the queue based on an error.

_Parameters_

-   _id_ `QueueItemId`: Item ID.
-   _error_ `Error`: Error instance.

#### convertGifItem

Converts an existing GIF item to a video.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### convertHeifItem

Converts an existing HEIF image item to another format.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### fetchRemoteFile

Fetches a remote file from another server and adds it to the item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.
-   _args_ `FetchRemoteFileArgs`: Additional arguments for the operation.

#### finishOperation

Finishes an operation for a given item ID and immediately triggers processing the next one.

_Parameters_

-   _id_ `QueueItemId`: Item ID.
-   _updates_ `Partial< QueueItem >`: Updated item data.

#### generateSubtitles

Generates subtitles for the video item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### generateThumbnails

Adds thumbnail versions to the queue for sideloading.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### grantApproval

Approves a proposed optimized/converted version of a file so it can continue being processed and uploaded.

_Parameters_

-   _id_ `number`: Item ID.

#### muteExistingVideo

Adds a new item to the upload queue for muting an existing video.

_Parameters_

-   _$0_ `MuteExistingVideoArgs`: 
-   _$0.id_ `MuteExistingVideoArgs[ 'id' ]`: Attachment ID.
-   _$0.url_ `MuteExistingVideoArgs[ 'url' ]`: Video URL.
-   _$0.fileName_ `[MuteExistingVideoArgs[ 'fileName' ]]`: Video file name.
-   _$0.poster_ `[MuteExistingVideoArgs[ 'poster' ]]`: Poster URL.
-   _$0.onChange_ `[MuteExistingVideoArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[MuteExistingVideoArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onError_ `[MuteExistingVideoArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[MuteExistingVideoArgs[ 'additionalData' ]]`: Additional data to include in the request.
-   _$0.blurHash_ `[MuteExistingVideoArgs[ 'blurHash' ]]`: Item's BlurHash.
-   _$0.dominantColor_ `[MuteExistingVideoArgs[ 'dominantColor' ]]`: Item's dominant color.
-   _$0.generatedPosterId_ `[MuteExistingVideoArgs[ 'generatedPosterId' ]]`: Attachment ID of the generated poster image, if it exists.

#### muteVideoItem

Mutes an existing video item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### optimizeAudioItem

Optimizes/Compresses an existing audio item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### optimizeExistingItem

Adds a new item to the upload queue for optimizing (compressing) an existing item.

_Parameters_

-   _$0_ `OptimizexistingItemArgs`: 
-   _$0.id_ `OptimizexistingItemArgs[ 'id' ]`: Attachment ID.
-   _$0.url_ `OptimizexistingItemArgs[ 'url' ]`: URL.
-   _$0.fileName_ `[OptimizexistingItemArgs[ 'fileName' ]]`: File name.
-   _$0.poster_ `[OptimizexistingItemArgs[ 'poster' ]]`: Poster URL.
-   _$0.batchId_ `[OptimizexistingItemArgs[ 'batchId' ]]`: Batch ID.
-   _$0.onChange_ `[OptimizexistingItemArgs[ 'onChange' ]]`: Function called each time a file or a temporary representation of the file is available.
-   _$0.onSuccess_ `[OptimizexistingItemArgs[ 'onSuccess' ]]`: Function called after the file is uploaded.
-   _$0.onBatchSuccess_ `[OptimizexistingItemArgs[ 'onBatchSuccess' ]]`: Function called after a batch of files is uploaded.
-   _$0.onError_ `[OptimizexistingItemArgs[ 'onError' ]]`: Function called when an error happens.
-   _$0.additionalData_ `[OptimizexistingItemArgs[ 'additionalData' ]]`: Additional data to include in the request.
-   _$0.blurHash_ `[OptimizexistingItemArgs[ 'blurHash' ]]`: Item's BlurHash.
-   _$0.dominantColor_ `[OptimizexistingItemArgs[ 'dominantColor' ]]`: Item's dominant color.
-   _$0.generatedPosterId_ `[OptimizexistingItemArgs[ 'generatedPosterId' ]]`: Attachment ID of the generated poster image, if it exists.

#### optimizeImageItem

Optimizes/Compresses an existing image item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.
-   _args_ `[OptimizeImageItemArgs]`: Additional arguments for the operation.

#### optimizeVideoItem

Optimizes/Compresses an existing video item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### pauseQueue

Returns an action object that pauses all processing in the queue.

Useful for testing purposes.

_Returns_

-   `PauseQueueAction`: Action object.

#### prepareItem

Prepares an item for initial processing.

Determines the list of operations to perform for a given image, depending on its media type.

For example, HEIF images first need to be converted, resized, compressed, and then uploaded.

Or videos need to be compressed, and then need poster generation before upload.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### processItem

Processes a single item in the queue.

Runs the next operation in line and invokes any callbacks.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### rejectApproval

Rejects a proposed optimized/converted version of a file by essentially cancelling its further processing.

_Parameters_

-   _id_ `number`: Item ID.

#### resizeCropItem

Resizes and crops an existing image item.

_Parameters_

-   _id_ `QueueItemId`: Item ID.
-   _args_ `[ResizeCropItemArgs]`: Additional arguments for the operation.

#### resumeItem

Resumes processing for a given post/attachment ID.

_Parameters_

-   _postOrAttachmentId_ `number`: Post or attachment ID.

#### resumeQueue

Resumes all processing in the queue.

Dispatches an action object for resuming the queue itself, and triggers processing for each remaining item in the queue individually.

#### revokeBlobUrls

Revokes all blob URLs for a given item, freeing up memory.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### setImageSizes

Returns an action object that sets all image sub-sizes and their cropping information.

_Parameters_

-   _imageSizes_ `Record< string, ImageSizeCrop >`: Map of image size names and their cropping information.

_Returns_

-   `SetImageSizesAction`: Action object.

#### setMediaSourceTerms

Returns an action object that sets the media source term slugs and IDs.

_Parameters_

-   _terms_ `Record< string, number >`: Map of term slugs to IDs.

_Returns_

-   `SetMediaSourceTermsAction`: Action object.

#### sideloadItem

Sideloads an item to the server.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### uploadItem

Uploads an item to the server.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### uploadOriginal

Adds the original file to the queue for sideloading.

If an item was downsized due to the big image size threshold, this adds the original file for storing.

_Parameters_

-   _id_ `QueueItemId`: Item ID.

#### uploadPoster

Adds an item's poster image to the queue for uploading.

_Parameters_

-   _id_ `QueueItemId`: Item ID.


<!-- END TOKEN(Autogenerated actions|src/store/actions.ts) -->

### Selectors

The following selectors are available on the object returned by `wp.data.select( 'media-experiments/upload' )`:

**Note:** Some actions and selectors [will be made private](https://github.com/swissspidy/media-experiments/issues/500) eventually, limiting the public API.

<!-- START TOKEN(Autogenerated selectors|src/store/selectors.ts) -->

#### getBlobUrls

Returns all cached blob URLs for a given item ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _id_ `QueueItemId`: Item ID

_Returns_

-   `string[]`: List of blob URLs.

#### getComparisonDataForApproval

Returns data to compare the old file vs. the optimized file, given the attachment ID.

Includes both the URLs as well as the respective file sizes and the size difference in percentage.

_Parameters_

-   _state_ `State`: Upload state.
-   _attachmentId_ `number`: Attachment ID.

_Returns_

-   `{ oldUrl: string | undefined; oldSize: number; newSize: number; newUrl: string | undefined; sizeDiff: number; } | null`: Comparison data.

#### getImageSize

Returns an image size given its name.

_Parameters_

-   _state_ `State`: Upload state.
-   _name_ `string`: Image size name.

_Returns_

-   `ImageSizeCrop`: Image size data.

#### getItem

Returns a specific item given its unique ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _id_ `QueueItemId`: Item ID.

_Returns_

-   `QueueItem | undefined`: Queue item.

#### getItemByAttachmentId

Returns a specific item given its associated attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _attachmentId_ `number`: Item ID.

_Returns_

-   `QueueItem | undefined`: Queue item.

#### getItems

Returns all items currently being uploaded.

_Parameters_

-   _state_ `State`: Upload state.
-   _status_ `ItemStatus`: Status to filter items by.

_Returns_

-   `QueueItem[]`: Queue items.

#### getMediaSourceTermId

Returns a media source term ID given its slug.

_Parameters_

-   _state_ `State`: Upload state.
-   _slug_ `MediaSourceTerm`: Term slug.

_Returns_

-   `number | undefined`: Term ID.

#### getPausedUploadForPost

Returns the next paused upload for a given post or attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _postOrAttachmentId_ `number`: Post ID or attachment ID.

_Returns_

-   `QueueItem | undefined`: Paused item.

#### isBatchUploaded

Determines whether a batch has been successfully uploaded, given its unique ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _batchId_ `BatchId`: Batch ID.

_Returns_

-   `boolean`: Whether a batch has been uploaded.

#### isFirstPendingApprovalByAttachmentId

Determines whether an item is the first one pending approval given its associated attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _attachmentId_ `number`: Attachment ID.

_Returns_

-   `boolean`: Whether the item is first in the list of items pending approval.

#### isPaused

Determines whether uploading is currently paused.

_Parameters_

-   _state_ `State`: Upload state.

_Returns_

-   `boolean`: Whether uploading is currently paused.

#### isPendingApproval

Determines whether there is an item pending approval.

_Parameters_

-   _state_ `State`: Upload state.

_Returns_

-   `boolean`: Whether there is an item pending approval.

#### isPendingApprovalByAttachmentId

Determines whether there is an item pending approval given its associated attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _attachmentId_ `number`: Attachment ID.

_Returns_

-   `boolean`: Whether the item is pending approval.

#### isUploading

Determines whether any upload is currently in progress.

_Related_

-   <https://github.com/WordPress/gutenberg/blob/a889ec84318fe5ee9ee76f1226b30283b27c99a7/packages/edit-post/src/components/header/index.js#L35>

_Parameters_

-   _state_ `State`: Upload state.

_Returns_

-   `boolean`: Whether any upload is currently in progress.

#### isUploadingByBatchId

Determines whether an upload is currently in progress given a batch ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _batchId_ `BatchId`: Batch ID.

_Returns_

-   `boolean`: Whether upload is currently in progress for the given batch ID.

#### isUploadingById

Determines whether an upload is currently in progress given an attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _attachmentId_ `number`: Attachment ID.

_Returns_

-   `boolean`: Whether upload is currently in progress for the given attachment.

#### isUploadingByParentId

Determines whether an upload is currently in progress given a parent ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _parentId_ `QueueItemId`: Parent ID.

_Returns_

-   `boolean`: Whether upload is currently in progress for the given parent ID.

#### isUploadingByUrl

Determines whether an upload is currently in progress given an attachment URL.

_Parameters_

-   _state_ `State`: Upload state.
-   _url_ `string`: Attachment URL.

_Returns_

-   `boolean`: Whether upload is currently in progress for the given attachment.

#### isUploadingToPost

Determines whether an upload is currently in progress given a post or attachment ID.

_Parameters_

-   _state_ `State`: Upload state.
-   _postOrAttachmentId_ `number`: Post ID or attachment ID.

_Returns_

-   `boolean`: Whether upload is currently in progress for the given post or attachment.

<!-- END TOKEN(Autogenerated selectors|src/store/selectors.ts) -->
